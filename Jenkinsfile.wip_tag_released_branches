// Curl site

@Library('genome') _
def senseislack = new org.klick.SenseiSlack()

node('sensei_build') {

  try {

    def check_URL = 'https://genome.klick.com/'
    def warnings = []
    def sha = get_deployed_sha_from_manifest(check_URL, warnings)
    echo "GOT SHA: ${sha}"
    echo "warnings: ${warnings}"
    
    // def msg = [ subject: 'hi', body: 'there', channel: 'jenkins-dev-tests' ]
    // senseislack.post_success(msg)
  }
  catch(err) {
    echo "FAILED: ${err}"
    currentBuild.result = 'FAILURE'
    
    // def msg = [ subject: 'failed', body: "ERROR: ${err}", channel: 'jenkins-dev-tests' ]
    // senseislack.post_failure(msg)
  }
}


///////////////////////////////////////


// Get the sha from the deployed manifest, collecting warnings.
def get_deployed_sha_from_manifest(check_URL, warnings) {
    manifest_url = "${check_URL}/manifest.json"
    def myscript = "Invoke-WebRequest ${manifest_url} | ConvertFrom-Json | Select -ExpandProperty vcs-shaxxx"
    def sha = null
    try {
      sha = powershell(returnStdout: true, script: myscript).trim()
      if (sha == '') { sha == null }
      if (sha == null) {
        warnings << "Missing sha from ${manifest_url}"
      }
    }
    catch (err) {
      msg = "Error getting sha from ${manifest_url}: ${err} (check the log for details)"
      echo msg
      warnings << msg
      echo "Suppressing and continuing"
    }
    return sha
}
