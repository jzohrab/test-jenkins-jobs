// Curl site

@Library('genome') _
def senseislack = new org.klick.SenseiSlack()

node('sensei_build') {

  try {

    def check_urls = [
      'https://genome.klick.com/'
    ]

    def results = check_urls.collect { url ->
      def data = get_deployed_sha_from_manifest(url)
      [ site: url, sha: data.sha, error: data.error ]
    }

    echo "Results: ${results}"

    get_untagged_release_branches(/refs\/heads\/release-\d+/, /refs\/tags\/genome_\d+/)

    // def msg = [ subject: 'hi', body: 'there', channel: 'jenkins-dev-tests' ]
    // senseislack.post_success(msg)

  }
  catch(err) {
    echo "FAILED: ${err}"
    currentBuild.result = 'FAILURE'
    
    // def msg = [ subject: 'failed', body: "ERROR: ${err}", channel: 'jenkins-dev-tests' ]
    // senseislack.post_failure(msg)
  }
}


///////////////////////////////////////


// Get the sha from the deployed manifest.
def get_deployed_sha_from_manifest(check_URL) {
  def result = [ sha: null, error: null ]
  
  manifest_url = "${check_URL}/manifest.json"
  try {
    // See https://stackoverflow.com/questions/1408042/output-data-with-no-column-headings-using-powershel
    // re "-ExpandProperty" flag.
    def myscript = "Invoke-WebRequest ${manifest_url} | ConvertFrom-Json | Select -ExpandProperty vcs-sha"
    def tmp = powershell(returnStdout: true, script: myscript).trim()
    if (tmp.trim().size() == 0) { tmp = null }
    result.sha = tmp
    if (result.sha == null) {
      result.error = "Null sha (missing vcs-sha from ${manifest_url} ?)"
    }
  }
  catch (err) {
    result.error = "Error getting sha from ${manifest_url}: ${err} (check the log for details)"
  }
  return result
}



def ls_remote_objects_matching_pattern(repo_url, object_type, pattern) {
  def cmd = "git ls-remote ${object_type} ${repo_url}"
  // I tried using <refs> to limit the output of ls-remote, but it didn't work
  // (would filter out all branches/tags).  Getting everything and filtering locally ...
  // wasteful, but it will work.

  def data = bat(returnStdout: true, script: cmd).
    split("\n").
    findAll { it =~ pattern }.       // Remove command, and empty blank lines
    findAll { !(it =~ /\^\{\}$/) }.  // ls-remote adds extra lines with "^{}" for tags
    collect { it.split("\t") }

  echo "GOT data = ${data}"
  def ret = data.collect { [ sha: it[0], object: it[1] ] }
  echo "GOT ret = ${ret}"
  return ret
}


def get_untagged_release_branches(branch_pattern, tag_pattern) {

    withCredentials([usernamePassword(credentialsId: 'github-ci', passwordVariable: 'P', usernameVariable: 'U')]) {

      def repo_url = "https://${U}:${P}@github.com/KlickInc/klick-genome"

      def tag_list = ls_remote_objects_matching_pattern(repo_url, '--tags', tag_pattern)
      def tag_shas = tag_list.collect { it.sha }
      echo "tags: ${tag_list}"
      echo "shas: ${tag_shas}"

      def branch_list = ls_remote_objects_matching_pattern(repo_url, '--heads', branch_pattern)
      echo "BRANCHES"
      echo "${branch_list}"

      def untagged_branches = branch_list.findAll { !(tag_shas.contains(it.sha)) }
      echo "Got untagged: ${untagged_branches}"
      
    }

}
    
